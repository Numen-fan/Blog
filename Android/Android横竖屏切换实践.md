# Android横竖屏切换实践

## 1、前言

前段时间，PM提了一个需求，在APP内直播观众和回放页面，需要增加一个横竖屏切换的按钮，和当前众多视频APP的横竖屏切换行为保持一致。

当拿到这个需求的时候，觉得是easy模式，无非就是`setRequestedOrientation(横屏/竖屏)`就ok了。但交互评审和查看B站、虎牙、钉钉等APP之后，并不是自己想得那么easy。因为忽略了一个很重要的设置——屏幕自动旋转。

## 2、需求分析

先将需求分析清楚，其实从系统锁定（下拉菜单里面是否打开了自动旋转）的角度分为两种情况：

- 系统关闭自动旋转。
- 系统打开自动旋转。

> 这里先不要考虑Activity的模式是`ActivityInfo.SCREEN_ORIENTATION_SENSOR`, 即使是，也是一样处理，这点后面会讲。

对于这两种情况，我们来看看延生出来的情况

![](https://raw.githubusercontent.com/Numen-fan/BlogPicRepo/main/img/20230213193249.png)

【说明】

1. 对于屏幕自动旋转关闭的情况下，情况比较简单，用户手动切换了横竖屏后，保持不动即可。
2. 如果屏幕自动旋转打开的情况，用户手动切换了横竖屏，此时需要增加一个策略，如果用户旋转屏幕到对应的方向，需要恢复自动旋转。
   1. 举个栗子：在竖屏观看状态下，用户点击切换，此时屏幕切换到横屏，手机仍然是竖屏状态。用户旋转90度到手机也是横屏时，随后用户再竖直回手机，屏幕能够自动旋转回竖屏。（读起来有点饶）

## 3、功能实现

经过上面的分析，我们可以得出两个需要去解决的关键点

【关键点1】监听系统自动旋转设置。

【关键点2】监听用户旋转到用户设置的方向。

### 3.1 监听系统自动旋转设置

首先，我们要知道如何读取系统设置的有关屏幕自动旋转的值

```java
// 0 off / 1 on
Settings.System.getInt(getContentResolver(), Settings.System.ACCELEROMETER_ROTATION）
```

我们可以封一个方法，表示系统自动旋转是否打开。

```java
canRotation
```

我的知道了如何获取设置值，那么什么时候去读取呢，当然是系统监听到设置的值发生了变化。

可以使用内容观察者`ContentObserver`来监听设置值的变化。我们新建一个类，继承自`ContentObserver`, 并在内部定义一个接口，将观测结果回调。这样的封装，可以提供多处使用。

```java
监听系统设置值的代码
```

### 3.2 监听屏幕旋转

这里的监听屏幕旋转，并不是简单的`onConfigChanged()`，准确来说是监听屏幕的旋转角度。

上面提到，我们需要知道用户手动设置了横竖屏后，手机何时旋转到对应的位置，此时需要恢复Activity到默认的旋转行为。

我们可以借助`OrientationEventListener`，实时的获取当前手机的旋转角度，从而计算出当前手机的横竖状态。这里可以补一下旋转角度的知识。

- 正常竖直状态（信号电量状态栏朝上），orientation = 0。
- 横屏状态1（信号电量状态栏朝左），orientation = 270。
- 反向竖直状态（信号电量状态栏朝下），orientation = 180。
- 横屏状态2 （信号电量状态栏朝右），orientation = 90。

同样我们可以封装一下

```java
监听屏幕旋转的代码
```

### 3.3 使用

假设我们有一个按钮，每次点击就是切换横竖屏

```
按钮事件
```







# 资料

[Android ContentObserver](https://juejin.cn/post/7031511196125626398)









