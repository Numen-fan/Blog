# NDK开发—Hello World

> 开始尝试NDK开发了。

## 前言废语

关于NDK和JNI的概念介绍，网上一搜一麻袋就不做介绍了，站在初学者的角度，我们可以简单的这样李姐：

- NDK（Native develop kit）就是一套工具，能够使用C/C++语言来实现部分功能。。
- JNI（Java Native Interface）一种接口约定，满足java和C/C++之间的相互调用。

当然这里面有很多内容，比如JavaVM、JNIEnv、JNI原理等等，这些对于初学者都不重要，我也不懂，先会用，再深入吧。

## 环境配置

这一节可以参考官方教程[向您的项目添加 C 和 C++ 代码](https://developer.android.com/studio/projects/add-native-code?hl=zh-cn) 

- Android studio版本 Bumblebee
- NDK版本 20+

1. 在`sdk manager`中安装NDK和CMake

![](https://raw.githubusercontent.com/Numen-fan/BlogPicRepo/main/img/20220901174720.png)

2. 在`Project Structure` 中指定NDK路径，如果说没有，按照提示下载即可。

![](https://raw.githubusercontent.com/Numen-fan/BlogPicRepo/main/img/20220901175054.png)

- 下载结束后Apply时如果提示`NDK does not contain any platforms`，自己到相应的路径下面新建一个名为`platforms`的目录文件。
- 注意到local.properties文件中确认是否有`ndk.dir`

## 开始打代码

### 编写C相关的代码

1. 新建一个NDKTools类文件，内如如下，加上native修饰符，表示这个方法是native实现。

```java
package com.jiajia.mypractisedemos.module.ndk;

/**
 * Created by Numen_fan on 2022/9/1
 * Desc:
 **/
public class NDKTools {

    public static native String getStringFromNDK();

}
```

2. 进行项目的编译，就是build一下，生成NDKTools.class文件。这个class文件在`/app/build/intermediates/javac/debug/classes`目录下。
3. 终端进入到`/app/build/intermediates/javac/debug/classes`目录，执行如下命令。

```bash
javah -jni com.jiajia.mypractisedemos.module.ndk.NDKTools
```

> 注意前面拼上完整的包名，这里我尝试进入到ndk目录下，然后执行javah -jni NDKTools，提示失败。

4. 执行完之后，会在`/app/build/intermediates/javac/debug/classes`下生成一个`.h`的头文件；内容如下：

```c
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class com_jiajia_mypractisedemos_module_ndk_NDKTools */

#ifndef _Included_com_jiajia_mypractisedemos_module_ndk_NDKTools
#define _Included_com_jiajia_mypractisedemos_module_ndk_NDKTools
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     com_jiajia_mypractisedemos_module_ndk_NDKTools
 * Method:    getStringFromNDK
 * Signature: ()Ljava/lang/String;
 */
JNIEXPORT jstring JNICALL Java_com_jiajia_mypractisedemos_module_ndk_NDKTools_getStringFromNDK
  (JNIEnv *, jclass);

#ifdef __cplusplus
}
#endif
#endif

```

- 还记得`.h`文件在C语言中的角色吗？其实就是**函数声明**拉。
- 注意看第一行，提示我们不要擅自编辑呢。

4. 新建jni目录，如果你的项目没有jni目录，按照下面的方式新建，不要`New -> Package`

![](https://raw.githubusercontent.com/Numen-fan/BlogPicRepo/main/img/20220901192113.png)

这样新建的jni目录，会在app的build.gradle中自动添加如下配置

```groovy
sourceSets {
        main {
            jni {
                srcDirs 'src/main/jni'
            }
        }
    }
```

6. 将刚才生成的`.h`声明文件，移动到jni目录下。
7. 在jni目录下新建一个C语言文件`ndkdemotest.c`，编写代码如下

```c
#include "com_jiajia_mypractisedemos_module_ndk_NDKTools.h"

JNIEXPORT jstring JNICALL Java_com_jiajia_mypractisedemos_module_ndk_NDKTools_getStringFromNDK
  (JNIEnv *env, jclass obj) {
    return (*env) -> NewStringUTF(env, "我是JNI的Hello World啊");
  }
```

- 注意第一行，需要将刚才的`.h`声明文件引入。
- NewStringUTF是啥，不重要，先知道他返回了一个字符串就行。

8. 同在jni目录下新建`Android.mk`文件，写上如下内容

```groovy
LOCAL_PATH := $(call my-dir)

include $(CLEAR_VARS)

LOCAL_MODULE    := ndkdemotest-jni

LOCAL_SRC_FILES := ndkdemotest.c

include $(BUILD_SHARED_LIBRARY)
```

- 关于各个字段的含义，可以找些资料看一下，我还没搞懂。大体意思就是一些配置，来生成产物。
- 注意`LOCAL_SRC_FILES`，这个应该就是指定要编译的C文件；**TODO：如果需要编译多个C文件呢？**
- `LOCAL_MODULE` 应该就是指定产物的名称，xxxx.so ?

9. 在app的build.gradle中添加如下两处配置。

```groovy
android {
  defaultConfig {
    ……
    ndk{   // 1
            moduleName "ndkdemotest-jni"
            abiFilters "arm64-v8a", "armeabi-v7a"
        }
  }
  externalNativeBuild {  // 2
        ndkBuild {
            path 'src/main/jni/Android.mk'
        }
    }
  ……
}

```

10. 在代码中load产物，我就写在NDKTools类中。

```
static {
        System.loadLibrary("ndkdemotest-jni");
    }
```

到这里，C相关的编码和配置就完成了，这时候可以跑一下代码，看看会不会报错，如果报错的话，就网上找找办法如何解决。

### 编写Android层代码

1. Android层的代码就很简单了。

```java
String text = NDKTools.getStringFromNDK();
((TextView)findViewById(R.id.tv_ndk_string)).setText(text);
```

2. 运行效果

![](https://raw.githubusercontent.com/Numen-fan/BlogPicRepo/main/img/20220901194345.png)

## 参考资料

1. https://www.jianshu.com/p/b4431ac22ec2。【重点参考的文章】
2. https://www.jianshu.com/p/87ce6f565d37

3. https://developer.android.com/studio/projects/add-native-code?hl=zh-cn
4. https://blog.csdn.net/qq_33221533/article/details/113173396
5. https://blog.csdn.net/weixin_37639900/article/details/99866131